{% extends "base.html" %}

{% block title %}Manager Dashboard - ChipSight{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/manager.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/manager_charts.js') }}"></script>
<style>
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .card-body {
        padding: 1rem;
    }
    .search-container {
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .search-results {
        margin-top: 1rem;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hidden data fields for charts -->
    <input type="hidden" id="production-data" value="{{ production_summary|tojson|safe }}">
    <input type="hidden" id="machine-stats" value="{{ machine_stats|tojson|safe }}">
    <input type="hidden" id="machine-uptime" value="{{ machine_uptime|tojson|safe }}">
    <input type="hidden" id="production-summary" value="{{ production_summary|tojson|safe }}">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <!-- End Flash Messages -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Manager Dashboard</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <form method="POST" action="{{ url_for('logout_general') }}" class="d-inline">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </form>
        </div>
    </div>

    <!-- SAP ID Search Bar -->
    <div class="search-container">
        <div class="row">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="sapIdSearch" class="form-control" placeholder="Search by SAP ID...">
                    <button class="btn btn-primary" type="button" onclick="searchDrawing()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </div>
        </div>
        <div id="searchResults" class="search-results" style="display:none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Drawing Details</h5>
                    <div id="drawingDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Total Production</h6>
                            <h3 class="mb-0">{{ production_summary|sum(attribute=3)|default(0) }}</h3>
                        </div>
                        <i class="fas fa-industry fa-2x opacity-50"></i>
                    </div>
                    <small class="text-white-50">Parts Completed Today</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Quality Pass Rate</h6>
                            <h3 class="mb-0">
                                {% set total = production_summary|sum(attribute=3)|default(0) %}
                                {% set rejected = production_summary|sum(attribute=4)|default(0) %}
                                {% if total > 0 %}
                                    {{ "%.1f"|format(((total - rejected) / total * 100)) }}%
                                {% else %}
                                    0.0%
                                {% endif %}
                            </h3>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                    <small class="text-white-50">Passed Quality Checks</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Rework Items</h6>
                            <h3 class="mb-0">{{ production_summary|sum(attribute=5)|default(0) }}</h3>
                        </div>
                        <i class="fas fa-sync-alt fa-2x opacity-50"></i>
                    </div>
                    <small class="text-dark-50">Items Requiring Rework</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Machine Utilization</h6>
                            <h3 class="mb-0" id="machine-utilization">0%</h3>
                        </div>
                        <i class="fas fa-cogs fa-2x opacity-50"></i>
                    </div>
                    <small class="text-white-50">Active Machines</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Production by Product</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="productionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Machine Status</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="machineStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Machine Utilization and Uptime -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Machine Utilization</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="machineUtilizationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Machine Uptime Today</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="uptimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Production Stats -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-industry me-2"></i>Production Statistics</h5>
                </div>
                <div class="card-body">
                    <canvas id="productionStatsChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Machine Utilization (Running vs Idle)</h5>
                </div>
                <div class="card-body">
                    <canvas id="machineUtilizationRunningIdleChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-network-wired me-2"></i>Production & Quality Summary</span>
                    <a href="{{ digital_twin_url }}" class="btn btn-light btn-sm"><i class="fas fa-eye me-1"></i>View Full Digital Twin</a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6>Production Summary</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead><tr><th>End Product</th><th>SAP ID</th><th>Planned</th><th>Completed</th><th>Rejected</th><th>Rework</th></tr></thead>
                                    <tbody>
                                        {% if production_summary|length == 0 %}
                                        <tr><td colspan="6" class="text-center text-muted">No records found</td></tr>
                                        {% else %}
                                        {% for name, sap_id, planned, completed, rejected, rework in production_summary %}
                                        <tr><td>{{ name }}</td><td>{{ sap_id }}</td><td>{{ planned }}</td><td>{{ completed or 0 }}</td><td>{{ rejected or 0 }}</td><td>{{ rework or 0 }}</td></tr>
                                        {% endfor %}
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6>Recent Quality Checks</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead><tr><th>Type</th><th>Result</th><th>Inspector</th><th>Time</th></tr></thead>
                                    <tbody>
                                        {% for qc in recent_quality_checks %}
                                        <tr><td>{{ qc.check_type }}</td><td>{{ qc.result|title }}</td><td>{{ qc.inspector_name }}</td><td>{{ qc.timestamp.strftime('%Y-%m-%d %H:%M') }}</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6>Recent Rework</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead><tr><th>Drawing</th><th>Qty</th><th>Status</th><th>Reason</th><th>Time</th></tr></thead>
                                    <tbody>
                                        {% for rw in recent_rework %}
                                        <tr><td>{{ rw.drawing_rel.drawing_number if rw.drawing_rel else 'N/A' }}</td><td>{{ rw.quantity }}</td><td>{{ rw.status|replace('_',' ')|title }}</td><td>{{ rw.rejection_reason }}</td><td>{{ rw.created_at.strftime('%Y-%m-%d %H:%M') }}</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6>Recent Scrap/Rejected</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead><tr><th>Drawing</th><th>Qty</th><th>Reason</th><th>Time</th></tr></thead>
                                    <tbody>
                                        {% for sc in recent_scrap %}
                                        <tr><td>{{ sc.drawing_rel.drawing_number if sc.drawing_rel else 'N/A' }}</td><td>{{ sc.quantity_scrapped }}</td><td>{{ sc.reason }}</td><td>{{ sc.scrapped_at.strftime('%Y-%m-%d %H:%M') }}</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Upload Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-file-import me-2"></i>Upload Drawing-SAP Mapping</h5>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">Upload Drawing-SAP Mapping (.xlsx)</label>
                    <input class="form-control" type="file" name="drawing_mapping_file" accept=".xlsx" required>
                    <small class="text-muted">File must contain columns: drawing_number, sap_id</small>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>Upload Mapping
                </button>
            </form>
        </div>
    </div>

    <!-- Drawing-SAP Mappings Section -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Current Drawing-SAP Mappings</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Drawing Number</th>
                            <th>SAP ID</th>
                            <th>Linked End Product</th>
                            <th>Project</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for drawing in drawings %}
                        <tr>
                            <td>{{ drawing.drawing_number }}</td>
                            <td>{{ drawing.sap_id }}</td>
                            <td>
                                {% if drawing.end_product_rel %}
                                    {{ drawing.end_product_rel.name }}
                                {% else %}
                                    <span class="text-danger">Not linked</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if drawing.end_product_rel and drawing.end_product_rel.project_rel %}
                                    {{ drawing.end_product_rel.project_rel.project_name }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Rework Approval Section -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-sync-alt me-2"></i>Rework Approvals</h5>
        </div>
        <div class="card-body">
            {% if pending_rework %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Drawing Number</th>
                                <th>SAP ID</th>
                                <th>Quantity</th>
                                <th>Sent to Rework By</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in pending_rework %}
                            <tr>
                                <td>{{ item.drawing_rel.drawing_number if item.drawing_rel else 'N/A' }}</td>
                                <td>{{ item.drawing_rel.sap_id if item.drawing_rel else 'N/A' }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.source_operator_log_rel.operator_id if item.source_operator_log_rel else 'N/A' }}</td>
                                <td>{{ item.originating_quality_check_rel.rejection_reason }}</td>
                                <td>{{ item.status }}</td>
                                <td>
                                    <div class="btn-group">
                                        <form method="POST">
                                            <input type="hidden" name="rework_id" value="{{ item.id }}">
                                            <input type="hidden" name="action" value="approve_rework">
                                            <input type="hidden" name="manager_notes" value="Approved for rework">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-check me-1"></i>Approve
                                            </button>
                                        </form>
                                    </div>
                                    {% if item.status == 'manager_approved' %}
                                    <span class="badge bg-success">Approved</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center text-muted">No rework items pending approval.</p>
            {% endif %}
        </div>
    </div>

    <!-- Open Operator Logs Section -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Open Operator Logs</h5>
        </div>
        <div class="card-body">
            <div id="openLogsTableContainer">
                <p class="text-center text-muted">Loading open logs...</p>
            </div>
        </div>
    </div>

    <!-- Active Projects Section -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-industry me-2"></i>Active Projects</h5>
        </div>
        <div class="card-body">
            {% if projects %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Project Code</th>
                                <th>Project Name</th>
                                <th>End Product Name</th>
                                <th>SAP ID</th>
                                <th>Description</th>
                                <th>Route</th>
                                <th class="text-end">Planned Qty</th>
                                <th>Completion Date</th>
                                <th class="text-end">Std. Setup (min)</th>
                                <th class="text-end">Std. Cycle (min/pc)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in projects %}
                                {% for ep in project.end_products %}
                                <tr>
                                    {% if loop.first %}
                                    <td rowspan="{{ project.end_products|length }}">{{ project.project_code }}</td>
                                    <td rowspan="{{ project.end_products|length }}">{{ project.project_name }}</td>
                                    {% endif %}
                                    <td>{{ ep.name }}</td>
                                    <td>{{ ep.sap_id }}</td>
                                    <td>{{ project.description | nl2br }}</td>
                                    <td>{{ project.route }}</td>
                                    <td class="text-end">{{ ep.quantity }}</td>
                                    <td>{{ ep.completion_date.strftime('%Y-%m-%d') if ep.completion_date else 'N/A' }}</td>
                                    <td class="text-end">{{ "%.2f"|format(ep.setup_time_std) if ep.setup_time_std is not none else 'N/A' }}</td>
                                    <td class="text-end">{{ "%.2f"|format(ep.cycle_time_std) if ep.cycle_time_std is not none else 'N/A' }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td>{{ project.project_code }}</td>
                                    <td>{{ project.project_name }}</td>
                                    <td colspan="8" class="text-muted fst-italic">No end products defined for this project.</td>
                                </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center text-muted">No active projects available.</p>
            {% endif %}
        </div>
    </div>

    <!-- Deleted Projects Section -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-trash-alt me-2"></i>Deleted Projects</h5>
        </div>
        <div class="card-body">
            {% if deleted_projects %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Project Code</th>
                                <th>Project Name</th>
                                <th>Description</th>
                                <th>Route</th>
                                <th>Deleted At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in deleted_projects %}
                            <tr>
                                <td>{{ project.project_code }}</td>
                                <td>{{ project.project_name }}</td>
                                <td>{{ project.description | nl2br }}</td>
                                <td>{{ project.route }}</td>
                                <td>{{ project.deleted_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('manager_dashboard') }}" class="d-inline">
                                        <input type="hidden" name="action" value="restore_project">
                                        <input type="hidden" name="project_id" value="{{ project.id }}">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-undo me-1"></i>Restore
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center text-muted">No deleted projects available.</p>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // Initialize Socket.IO
    const socket = io();
    
    // Handle real-time updates
    socket.on('production_update', function(data) {
        // Update production summary table
        const tbody = document.querySelector('#production-summary tbody');
        tbody.innerHTML = '';
        
        data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.name}</td>
                <td>${item.sap_id}</td>
                <td>${item.planned}</td>
                <td>${item.completed}</td>
                <td>${item.rejected}</td>
                <td>${item.rework}</td>
                <td>${item.planned > 0 ? ((item.completed / item.planned) * 100).toFixed(1) : 0}%</td>
            `;
            tbody.appendChild(row);
        });
        
        // Update progress bars
        updateProgressBars();
        
        // Update charts
        updateCharts(data);
    });
    
    socket.on('machine_update', function(data) {
        // Update machine status cards
        data.forEach(machine => {
            const card = document.querySelector(`#machine-${machine.id}`);
            if (card) {
                card.querySelector('.machine-status').textContent = machine.status;
                card.querySelector('.operator-name').textContent = machine.current_operator || 'N/A';
                card.querySelector('.drawing-number').textContent = machine.current_job || 'N/A';
                card.querySelector('.runtime').textContent = `${machine.runtime.toFixed(1)} hours`;
                card.querySelector('.parts-completed').textContent = machine.parts_completed;
            }
        });
        
        // Update machine stats
        updateMachineStats(data);
    });
    
    // Update progress bars function
    function updateProgressBars() {
        const rows = document.querySelectorAll('#production-summary tbody tr');
        rows.forEach(row => {
            const completed = parseInt(row.cells[3].textContent);
            const planned = parseInt(row.cells[2].textContent);
            const progress = (completed / planned) * 100;
            
            const progressBar = row.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
            }
        });
    }
    
    // Update machine stats function
    function updateMachineStats(machines) {
        const activeMachines = machines.filter(m => m.status === 'running').length;
        const totalMachines = machines.length;
        const idleMachines = machines.filter(m => m.status === 'idle').length;
        const breakdownMachines = machines.filter(m => m.status === 'breakdown').length;
        
        document.querySelector('#active-machines').textContent = activeMachines;
        document.querySelector('#total-machines').textContent = totalMachines;
        document.querySelector('#idle-machines').textContent = idleMachines;
        document.querySelector('#breakdown-machines').textContent = breakdownMachines;
        
        // Update machine status chart
        if (window.machineStatusChart) {
            window.machineStatusChart.data.datasets[0].data = [
                activeMachines,
                idleMachines,
                breakdownMachines
            ];
            window.machineStatusChart.update();
        }
    }
    
    // Update charts function
    function updateCharts(data) {
        // Update production progress chart
        if (window.productionProgressChart) {
            const completed = data.reduce((sum, item) => sum + item.completed, 0);
            const planned = data.reduce((sum, item) => sum + item.planned, 0);
            const progress = planned > 0 ? (completed / planned) * 100 : 0;
            
            window.productionProgressChart.data.datasets[0].data = [progress, 100 - progress];
            window.productionProgressChart.update();
        }
        
        // Update quality metrics chart
        if (window.qualityMetricsChart) {
            const totalCompleted = data.reduce((sum, item) => sum + item.completed, 0);
            const totalRejected = data.reduce((sum, item) => sum + item.rejected, 0);
            const totalRework = data.reduce((sum, item) => sum + item.rework, 0);
            
            window.qualityMetricsChart.data.datasets[0].data = [
                totalCompleted,
                totalRejected,
                totalRework
            ];
            window.qualityMetricsChart.update();
        }
    }
    
    // Initialize charts and other existing functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Get data from hidden fields
        const productionData = JSON.parse(document.getElementById('production-data').value || '[]');
        const machineStats = JSON.parse(document.getElementById('machine-stats').value || '[]');
        const machineUptime = JSON.parse(document.getElementById('machine-uptime').value || '[]');
        
        // Production Chart
        const productionCtx = document.getElementById('productionChart').getContext('2d');
        new Chart(productionCtx, {
            type: 'bar',
            data: {
                labels: productionData.map(d => d.name),
                datasets: [{
                    label: 'Planned',
                    data: productionData.map(d => d.planned),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 1
                }, {
                    label: 'Completed',
                    data: productionData.map(d => d.completed),
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantity'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Production Progress by Product'
                    }
                }
            }
        });

        // Machine Status Chart
        const machineStatusCtx = document.getElementById('machineStatusChart').getContext('2d');
        new Chart(machineStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Running', 'Idle', 'Setup', 'Breakdown'],
                datasets: [{
                    data: [
                        machineStats.running || 0,
                        machineStats.idle || 0,
                        machineStats.setup || 0,
                        machineStats.breakdown || 0
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',   // Green for Running
                        'rgba(255, 193, 7, 0.8)',   // Yellow for Idle
                        'rgba(23, 162, 184, 0.8)',  // Blue for Setup
                        'rgba(220, 53, 69, 0.8)'    // Red for Breakdown
                    ],
                    borderColor: [
                        'rgb(40, 167, 69)',
                        'rgb(255, 193, 7)',
                        'rgb(23, 162, 184)',
                        'rgb(220, 53, 69)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Current Machine Status Distribution'
                    }
                }
            }
        });

        // Machine Utilization Chart
        const utilizationCtx = document.getElementById('machineUtilizationChart').getContext('2d');
        new Chart(utilizationCtx, {
            type: 'bar',
            data: {
                labels: machineStats.machines || [],
                datasets: [{
                    label: 'Utilization %',
                    data: machineStats.utilization || [],
                    backgroundColor: (machineStats.utilization || []).map(value => {
                        if (value >= 85) return 'rgba(40, 167, 69, 0.8)';  // Green
                        if (value >= 60) return 'rgba(255, 193, 7, 0.8)';  // Yellow
                        return 'rgba(220, 53, 69, 0.8)';  // Red
                    }),
                    borderColor: (machineStats.utilization || []).map(value => {
                        if (value >= 85) return 'rgb(40, 167, 69)';
                        if (value >= 60) return 'rgb(255, 193, 7)';
                        return 'rgb(220, 53, 69)';
                    }),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Utilization %'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Machine Utilization Rate'
                    }
                }
            }
        });

        // Uptime Chart
        const uptimeCtx = document.getElementById('uptimeChart').getContext('2d');
        new Chart(uptimeCtx, {
            type: 'line',
            data: {
                labels: machineUptime.times || [],
                datasets: machineUptime.machines.map(machine => ({
                    label: machine.name,
                    data: machine.uptime,
                    borderColor: machine.color,
                    backgroundColor: machine.color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    fill: true,
                    tension: 0.4
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Uptime %'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Machine Uptime Trend Today'
                    }
                }
            }
        });
    });

    function searchDrawing() {
        const sapId = document.getElementById('sapIdSearch').value.trim();
        if (!sapId) {
            alert('Please enter a SAP ID');
            return;
        }
        fetch(`/api/search_drawing/${sapId}`)
            .then(response => response.json())
            .then(data => {
                const resultsDiv = document.getElementById('searchResults');
                const detailsDiv = document.getElementById('drawingDetails');
                resultsDiv.style.display = 'block';
                if (data.error) {
                    detailsDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    return;
                }
                if (!data.exists) {
                    detailsDiv.innerHTML = `<div class="alert alert-warning">No drawing found with SAP ID: ${sapId}</div>`;
                    return;
                }
                let html = `
                    <table class="table table-bordered">
                        <tr><th>Drawing Number</th><td>${data.drawing_number}</td></tr>
                        <tr><th>SAP ID</th><td>${data.sap_id}</td></tr>
                        <tr><th>End Product</th><td>${data.end_product || 'N/A'}</td></tr>
                        <tr><th>Completed Quantity</th><td>${data.completed_quantity}</td></tr>
                        <tr><th>Rejected Quantity</th><td>${data.rejected_quantity}</td></tr>
                        <tr><th>Rework Quantity</th><td>${data.rework_quantity}</td></tr>
                    </table>`;
                if (data.last_operation) {
                    html += `
                        <h6 class="mt-3">Last Operation</h6>
                        <table class="table table-bordered">
                            <tr><th>Operator</th><td>${data.last_operation.operator}</td></tr>
                            <tr><th>Machine</th><td>${data.last_operation.machine}</td></tr>
                            <tr><th>Status</th><td>${data.last_operation.status}</td></tr>
                            <tr><th>Timestamp</th><td>${data.last_operation.timestamp}</td></tr>
                        </table>`;
                }
                detailsDiv.innerHTML = html;
            })
            .catch(error => {
                const detailsDiv = document.getElementById('drawingDetails');
                detailsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
    }

    // Add event listener for Enter key
    document.getElementById('sapIdSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchDrawing();
        }
    });

    function fetchOpenLogs() {
        fetch('/operator_log/open_logs')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('openLogsTableContainer');
                if (!data.logs || data.logs.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No open operator logs.</p>';
                    return;
                }
                let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>' +
                    '<th>Machine</th><th>Drawing</th><th>Operator</th><th>Shift</th><th>Status</th><th>Created At</th><th>Actions</th></tr></thead><tbody>';
                data.logs.forEach(log => {
                    html += `<tr>
                        <td>${log.machine}</td>
                        <td>${log.drawing}</td>
                        <td>${log.operator}</td>
                        <td>${log.shift}</td>
                        <td>${log.status.replace(/_/g, ' ')}</td>
                        <td>${log.created_at}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="closeLog(${log.id}, this)">Close Log</button></td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            });
    }

    function closeLog(logId, btn) {
        btn.disabled = true;
        fetch(`/operator_log/close_log/${logId}`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (response.ok) {
                fetchOpenLogs();
            } else {
                btn.disabled = false;
                alert('Failed to close log.');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetchOpenLogs();
    });
</script>
{% endblock %}
