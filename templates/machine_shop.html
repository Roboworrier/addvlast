{% extends "base.html" %}

{% block title %}Machine Shop{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Assignments</h5>
                    <h2 class="card-text">{{ total_assignments }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Running Jobs</h5>
                    <h2 class="card-text">{{ running_jobs }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Pending Assignments</h5>
                    <h2 class="card-text">{{ pending_assignments }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Completed Today</h5>
                    <h2 class="card-text">{{ completed_today }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Assignment Form -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Assign Drawing to Machine</h5>
                </div>
                <div class="card-body">
                    <form id="assignmentForm" method="POST" action="{{ url_for('machine_shop_assign') }}">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="drawing_number">Drawing Number/SAP ID</label>
                                    <input type="text" class="form-control drawing-number-input" name="drawing_number" required>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="machine_id">Machine</label>
                                    <select class="form-control" name="machine_id" required>
                                        <option value="">Select Machine</option>
                                        {% for machine in machines %}
                                        <option value="{{ machine.id }}">{{ machine.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group">
                                    <label for="quantity">Quantity</label>
                                    <input type="number" class="form-control" name="quantity" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group">
                                    <label>Total Qty</label>
                                    <input type="number" class="form-control total-quantity" readonly>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group">
                                    <label>Assigned Qty</label>
                                    <input type="number" class="form-control assigned-quantity" readonly>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group">
                                    <label>Remaining Qty</label>
                                    <input type="number" class="form-control remaining-quantity" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="tool_number">Tool Number</label>
                                    <input type="text" class="form-control tool-number" name="tool_number" pattern="[A-Z0-9_, ]+" required>
                                    <small class="form-text text-muted">Multiple tools: TOOL1,TOOL_3MM</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">Assign</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Machine Status Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Machine Assignments</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary" id="filterBtn">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="exportBtn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="assignmentsTable">
                            <thead>
                                <tr>
                                    <th>Machine</th>
                                    <th>Drawing</th>
                                    <th>Tool</th>
                                    <th>Assigned Qty</th>
                                    <th>Completed</th>
                                    <th>Total Qty</th>
                                    <th>Remaining Qty</th>
                                    <th>Status</th>
                                    <th>Operator</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assignment in assignments %}
                                <tr>
                                    <td>{{ assignment.machine_rel.name }}</td>
                                    <td>{{ assignment.drawing_rel.drawing_number }}</td>
                                    <td>{{ assignment.tool_number }}</td>
                                    <td>{{ assignment.assigned_quantity }}</td>
                                    <td>{{ assignment.completed_quantity }}</td>
                                    <td>{{ assignment.drawing_rel.end_product_rel.quantity if assignment.drawing_rel.end_product_rel else '' }}</td>
                                    <td>{{ (assignment.drawing_rel.end_product_rel.quantity - assignment.total_assigned) if assignment.drawing_rel.end_product_rel and assignment.total_assigned is not none else '' }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if assignment.status == 'running' 
                                            else 'warning' if assignment.status == 'assigned' 
                                            else 'info' if assignment.status == 'completed' 
                                            else 'secondary' }}">
                                            {{ assignment.status }}
                                        </span>
                                    </td>
                                    <td>{{ assignment.current_operator or 'Not Assigned' }}</td>
                                    <td>
                                        <div class="btn-group">
                                            {% if assignment.status == 'assigned' %}
                                            <button type="button" class="btn btn-sm btn-success transfer-btn" 
                                                    data-assignment-id="{{ assignment.id }}"
                                                    data-drawing="{{ assignment.drawing_rel.drawing_number }}"
                                                    data-machine="{{ assignment.machine_rel.name }}"
                                                    data-quantity="{{ assignment.assigned_quantity }}">
                                                <i class="fas fa-exchange-alt"></i> Transfer
                                            </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-sm btn-info view-history-btn"
                                                    data-assignment-id="{{ assignment.id }}">
                                                <i class="fas fa-history"></i> History
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transfer Drawing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transferForm" method="POST" action="{{ url_for('machine_shop_transfer') }}">
                    <input type="hidden" name="assignment_id" id="transfer_assignment_id">
                    <div class="mb-3">
                        <label class="form-label">Drawing</label>
                        <input type="text" class="form-control" id="transfer_drawing" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">From Machine</label>
                        <input type="text" class="form-control" id="transfer_from_machine" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">To Machine</label>
                        <select class="form-control" name="to_machine_id" required>
                            <option value="">Select Machine</option>
                            {% for machine in machines %}
                            <option value="{{ machine.id }}">{{ machine.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity to Transfer</label>
                        <input type="number" class="form-control" name="quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <textarea class="form-control" name="reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmTransfer">Transfer</button>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assignment History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table" id="historyTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Action</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Quantity</th>
                                <th>By</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Ensure jQuery is loaded first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<style>
  .table-responsive { overflow-x: auto; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Handle drawing number input for auto-fill
    function autofillDrawingInfo(e) {
        const input = e.target;
        const val = input.value.trim();
        // Only trigger if input is at least 5 characters (adjust as needed)
        if (!val || val.length < 5) {
            const form = input.closest('form');
            form.querySelector('.total-quantity').value = '';
            form.querySelector('.assigned-quantity').value = '';
            form.querySelector('.remaining-quantity').value = '';
            form.querySelector('.tool-number').value = '';
            return;
        }
        const form = input.closest('form');
        fetch(`/api/drawing_info/${encodeURIComponent(val)}`)
            .then(resp => resp.json())
            .then(data => {
                if (data && data.error) {
                    form.querySelector('.total-quantity').value = '';
                    form.querySelector('.assigned-quantity').value = '';
                    form.querySelector('.remaining-quantity').value = '';
                    form.querySelector('.tool-number').value = '';
                    // Only show alert if the field is not being cleared
                    if (val.length >= 5) {
                        alert('Drawing or SAP ID not found!');
                    }
                    return;
                }
                // Always set the values, even if they're 0
                form.querySelector('.total-quantity').value = data.total_quantity || '0';
                form.querySelector('.assigned-quantity').value = data.assigned_quantity || '0';
                form.querySelector('.remaining-quantity').value = data.remaining_quantity || '0';
                form.querySelector('.tool-number').value = data.recent_tool || '';
            })
            .catch(err => {
                console.error('Error fetching drawing info:', err);
                alert('Error fetching drawing info.');
            });
    }
    document.querySelectorAll('.drawing-number-input').forEach(function(input) {
        input.addEventListener('input', autofillDrawingInfo);
        input.addEventListener('blur', autofillDrawingInfo);
    });

    // Handle transfer button clicks
    document.querySelectorAll('.transfer-btn').forEach(button => {
        button.addEventListener('click', function() {
            const assignmentId = this.dataset.assignmentId;
            const drawing = this.dataset.drawing;
            const machine = this.dataset.machine;
            const quantity = this.dataset.quantity;

            // Set form values
            document.getElementById('transfer_assignment_id').value = assignmentId;
            document.getElementById('transfer_drawing').value = drawing;
            document.getElementById('transfer_from_machine').value = machine;
            
            // Set max quantity and default value
            const quantityInput = document.querySelector('#transferForm input[name="quantity"]');
            quantityInput.max = quantity;
            quantityInput.value = quantity;  // Set default to full quantity

            // Clear other fields
            document.querySelector('#transferForm select[name="to_machine_id"]').value = '';
            document.querySelector('#transferForm textarea[name="reason"]').value = '';

            new bootstrap.Modal(document.getElementById('transferModal')).show();
        });
    });

    // Handle transfer form submission
    document.getElementById('confirmTransfer').addEventListener('click', function() {
        const form = document.getElementById('transferForm');
        if (form.checkValidity()) {
            form.submit();
        } else {
            // Show validation errors
            form.reportValidity();
        }
    });

    // Handle history button clicks
    document.querySelectorAll('.view-history-btn').forEach(button => {
        button.addEventListener('click', function() {
            const assignmentId = this.dataset.assignmentId;
            fetch(`/machine_shop/history/${assignmentId}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#historyTable tbody');
                    tbody.innerHTML = data.history.map(item => `
                        <tr>
                            <td>${new Date(item.timestamp).toLocaleString()}</td>
                            <td>${item.action}</td>
                            <td>${item.from || '-'}</td>
                            <td>${item.to || '-'}</td>
                            <td>${item.quantity || '-'}</td>
                            <td>${item.by}</td>
                            <td>${item.reason || '-'}</td>
                        </tr>
                    `).join('');
                    new bootstrap.Modal(document.getElementById('historyModal')).show();
                });
        });
    });

    // Initialize DataTable with export buttons and move buttons to custom toolbar
    var table = $('#assignmentsTable').DataTable({
        order: [[0, 'asc']],
        pageLength: 25,
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'csvHtml5',
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: 'btn btn-outline-secondary btn-sm',
                title: 'Machine Assignments'
            },
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-outline-secondary btn-sm',
                title: 'Machine Assignments'
            }
        ]
    });
    // Move DataTables export buttons into the custom toolbar
    table.buttons().container().appendTo('.card-header .btn-group');
    // Filter button focuses the search box
    document.getElementById('filterBtn').addEventListener('click', function() {
        document.querySelector('input[type="search"]').focus();
    });
    // Export button triggers the CSV/Excel export dropdown
    document.getElementById('exportBtn').addEventListener('click', function() {
        // Show DataTables export buttons
        $('.dt-buttons .btn').first().focus();
        $('.dt-buttons .btn').get(0).click();
    });
});
</script>
{% endblock %} 